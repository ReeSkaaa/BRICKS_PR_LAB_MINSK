// ===== NAVIGATION PAGE ONLY =====
document.addEventListener('DOMContentLoaded', () => {
  const rfMap = document.getElementById('rfMap');
  if (!rfMap) return; // run only on navigation page

  const pinsLayer = document.getElementById('map-pins');
  const placeList = document.getElementById('place-list');
  const placeCard = document.getElementById('place-card');
  const cardClose = placeCard.querySelector('.card-close');
  const catList = document.getElementById('category-list');

  const searchInput = document.getElementById('nav-search');
  const searchBtn = document.getElementById('nav-search-btn');
  const filterOpen = document.getElementById('filter-open');
  const sortBySel = document.getElementById('sort-by');

  // Функция для получения координат региона из SVG
  function getRegionCenter(regionCode) {
    const path = document.querySelector(`path[data-code="${regionCode}"]`);
    if (!path) {
      console.warn(`Регион с кодом ${regionCode} не найден на карте`);
      return { x: 50, y: 50 }; // Центр карты по умолчанию
    }
    
    const svg = rfMap.querySelector('svg');
    const svgRect = svg.getBoundingClientRect();
    const bbox = path.getBBox();
    
    return {
      x: ((bbox.x + bbox.width / 2) / svgRect.width) * 100,
      y: ((bbox.y + bbox.height / 2) / svgRect.height) * 100
    };
  }

  // Автоматически инициализируем координаты регионов
  function initializeRegionCoords() {
    const regions = {};
    const paths = document.querySelectorAll('path[data-code]');
    
    paths.forEach(path => {
      const code = path.getAttribute('data-code');
      regions[code] = getRegionCenter(code);
    });
    
    return regions;
  }

  // Функция для автоматического распределения точек внутри региона
  function getRegionCoords(regionCode, index = 0, totalInRegion = 1, regionCoords) {
    const base = regionCoords[regionCode] || { x: 50, y: 50 };
    
    // Если в регионе только одно место - ставим в центр
    if (totalInRegion === 1) return base;
    
    // Для нескольких мест создаем сетку вокруг центра
    const gridSize = Math.ceil(Math.sqrt(totalInRegion));
    const spacing = 2; // расстояние между точками в %
    
    const row = Math.floor(index / gridSize);
    const col = index % gridSize;
    
    const offsetX = (col - (gridSize - 1) / 2) * spacing;
    const offsetY = (row - (gridSize - 1) / 2) * spacing;
    
    return {
      x: Math.max(2, Math.min(98, base.x + offsetX)),
      y: Math.max(2, Math.min(98, base.y + offsetY))
    };
  }

  // Автоматически назначаем координаты местам
  function assignCoordinatesToPlaces(places, regionCoords) {
    // Группируем места по регионам
    const placesByRegion = {};
    places.forEach(place => {
      if (!placesByRegion[place.region]) {
        placesByRegion[place.region] = [];
      }
      placesByRegion[place.region].push(place);
    });
    
    // Назначаем координаты для каждого региона
    Object.keys(placesByRegion).forEach(regionCode => {
      const placesInRegion = placesByRegion[regionCode];
      placesInRegion.forEach((place, index) => {
        if (!place.coords) {
          place.coords = getRegionCoords(regionCode, index, placesInRegion.length, regionCoords);
        }
      });
    });
    
    return places;
  }

  // Demo data - теперь без ручных координат!
  const PLACES = [
    { 
      id: 'p-ryba', 
      title: 'Ресторан Рыба моя', 
      cat: 'restaurant', 
      region: 'RU-MOW',
      city: 'Москва', 
      address: '1-я Тверская-Ямская ул., 21', 
      rating: 4.9, 
      distance: '0.5 км', 
      time: 'Открыто до 18:00',
      desc: 'Самый лучший рыбный ресторан Москвы.',
      img: 'https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
      // coords будет назначено автоматически
    },
    { 
      id: 'p-rest2', 
      title: 'Ресторан Морской Бриз', 
      cat: 'restaurant', 
      region: 'RU-SPE',
      city: 'Санкт-Петербург', 
      address: 'Невский пр., 50', 
      rating: 4.7, 
      distance: '1.2 км', 
      time: 'Открыто до 23:00',
      desc: 'Рыба на гриле, устрицы и авторские соусы.',
      img: 'https://images.unsplash.com/photo-1529042410759-befb1204b468?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'p-museum1', 
      title: 'Политехнический музей', 
      cat: 'museum', 
      region: 'RU-MOW',
      city: 'Москва', 
      address: 'Новая пл., 3/4', 
      rating: 4.6, 
      distance: '2.1 км', 
      time: 'Открыто до 20:00',
      desc: 'Один из старейших научно-технических музеев мира.',
      img: 'https://images.unsplash.com/photo-1527689368864-3a821dbccc34?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'p-park1', 
      title: 'Центральный парк', 
      cat: 'park', 
      region: 'RU-MOW',
      city: 'Москва', 
      address: 'ул. Горького, 1', 
      rating: 4.8, 
      distance: '0.8 км', 
      time: 'Открыто до 22:00',
      desc: 'Красивый парк в центре города.',
      img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'p-cafe1', 
      title: 'Кофейня Уют', 
      cat: 'cafe', 
      region: 'RU-SPE',
      city: 'Санкт-Петербург', 
      address: 'Литейный пр., 30', 
      rating: 4.5, 
      distance: '0.3 км', 
      time: 'Открыто до 21:00',
      desc: 'Уютная кофейня с домашней выпечкой.',
      img: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'p-shop1', 
      title: 'Сувенирная лавка', 
      cat: 'shop', 
      region: 'RU-MOW',
      city: 'Москва', 
      address: 'Арбат, 25', 
      rating: 4.3, 
      distance: '1.5 км', 
      time: 'Открыто до 20:00',
      desc: 'Сувениры и подарки ручной работы.',
      img: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    },
    // Добавим примеры для других регионов
    { 
      id: 'p-krasnodar', 
      title: 'Ресторан Кубань', 
      cat: 'restaurant', 
      region: 'RU-KDA',
      city: 'Краснодар', 
      address: 'ул. Красная, 100', 
      rating: 4.6, 
      distance: '0.7 км', 
      time: 'Открыто до 22:00',
      desc: 'Кухня Кубани в современном исполнении.',
      img: 'https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'p-ekb', 
      title: 'Музей Урала', 
      cat: 'museum', 
      region: 'RU-SVE',
      city: 'Екатеринбург', 
      address: 'пр. Ленина, 50', 
      rating: 4.4, 
      distance: '1.8 км', 
      time: 'Открыто до 19:00',
      desc: 'История и культура Уральского региона.',
      img: 'https://images.unsplash.com/photo-1527689368864-3a821dbccc34?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'p-rostov', 
      title: 'Донской рынок', 
      cat: 'shop', 
      region: 'RU-ROS',
      city: 'Ростов-на-Дону', 
      address: 'ул. Большая Садовая, 45', 
      rating: 4.2, 
      distance: '0.9 км', 
      time: 'Открыто до 19:00',
      desc: 'Свежие продукты с Дона.',
      img: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?q=80&w=400&auto=format&fit=crop',
      url: '#', 
      reserveUrl: '#'
    }
  ];

  // Инициализация координат регионов и назначение координат местам
  const REGION_COORDS = initializeRegionCoords();
  const PLACES_WITH_COORDS = assignCoordinatesToPlaces(PLACES, REGION_COORDS);

  const fmt = { rating: r => `${r.toFixed(1)}★` };
  let state = { cat: 'restaurant', search: '', open: 'all', sort: 'near', selectedId: null };

  // Render helpers
  function renderList(items) {
    placeList.innerHTML = '';
    items.forEach(p => {
      const el = document.createElement('div');
      el.className = 'place-item';
      el.dataset.id = p.id;
      el.innerHTML = `
        <img src="${p.img}" alt="${p.title}">
        <div>
          <div class="ptitle">${p.title}</div>
          <div class="pmeta">${p.distance} • ${p.time}</div>
        </div>
        <div class="pmeta">${fmt.rating(p.rating)}</div>`;
      el.addEventListener('click', () => selectPlace(p.id));
      placeList.appendChild(el);
    });
  }

  function renderPins(items) {
    console.log('Rendering pins:', items.length); // Debug
    pinsLayer.innerHTML = '';
    
    items.forEach(p => {
      const pin = document.createElement('button');
      pin.className = `poi-pin ${p.cat}`;
      pin.style.left = p.coords.x + '%';
      pin.style.top = p.coords.y + '%';
      pin.title = p.title;
      pin.dataset.id = p.id;
      
      pin.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        selectPlace(p.id); 
      });
      
      pinsLayer.appendChild(pin);
    });
  }

  function applyFilters() {
    const q = state.search.trim().toLowerCase();
    let items = PLACES_WITH_COORDS.filter(p =>
      (state.cat === 'all' || p.cat === state.cat) &&
      (q === '' || p.title.toLowerCase().includes(q) || p.address.toLowerCase().includes(q))
    );
    
    if (state.open === 'open') items = items.filter(p => !/закрыто/i.test(p.time));
    if (state.open === 'closed') items = items.filter(p => /закрыто/i.test(p.time));
    if (state.sort === 'rating') items.sort((a, b) => b.rating - a.rating);
    if (state.sort === 'az') items.sort((a, b) => a.title.localeCompare(b.title));

    renderList(items);
    renderPins(items);
    
    if (!items.some(p => p.id === state.selectedId)) hideCard();
  }

  function selectPlace(id) {
    state.selectedId = id;
    
    // Update active states
    document.querySelectorAll('.place-item').forEach(n => 
      n.classList.toggle('active', n.dataset.id === id));
    document.querySelectorAll('.poi-pin').forEach(n => 
      n.classList.toggle('active', n.dataset.id === id));

    const p = PLACES_WITH_COORDS.find(x => x.id === id);
    if (!p) return;

    // Fill popup
    placeCard.querySelector('.card-img').src = p.img;
    placeCard.querySelector('.card-img').alt = p.title;
    placeCard.querySelector('.card-title').textContent = p.title;
    placeCard.querySelector('.card-distance').textContent = p.distance;
    placeCard.querySelector('.card-time').textContent = p.time;
    placeCard.querySelector('.card-rating').textContent = fmt.rating(p.rating);
    placeCard.querySelector('.addr-btn').textContent = p.address;
    placeCard.querySelector('.card-desc').textContent = p.desc;
    placeCard.querySelector('.more-btn').href = p.url || '#';
    placeCard.querySelector('.reserve-btn').href = p.reserveUrl || '#';

    positionCard(p.coords);
    placeCard.hidden = false;
  }

  function positionCard(coords) {
    const wrap = document.getElementById('mapWrap');
    const mapBox = document.getElementById('rfMap');
    
    if (!wrap || !mapBox) return;
    
    const wrapRect = wrap.getBoundingClientRect();
    const mapRect = mapBox.getBoundingClientRect();

    let left = (coords.x / 100) * mapRect.width + (mapRect.left - wrapRect.left) + 16;
    let top = (coords.y / 100) * mapRect.height + (mapRect.top - wrapRect.top) - 16;

    const w = placeCard.offsetWidth || 400;
    const h = placeCard.offsetHeight || 230;

    const maxL = wrap.clientWidth - w - 24;
    const maxT = wrap.clientHeight - h - 24;
    
    if (left > maxL) left = (coords.x / 100) * mapRect.width + (mapRect.left - wrapRect.left) - w - 16;
    left = Math.max(24, Math.min(left, maxL));
    top = Math.max(24, Math.min(top, maxT));

    placeCard.style.left = left + 'px';
    placeCard.style.top = top + 'px';
  }

  function hideCard() {
    placeCard.hidden = true;
    state.selectedId = null;
    document.querySelectorAll('.poi-pin.active').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.place-item.active').forEach(n => n.classList.remove('active'));
  }

  // UI event listeners
  catList.addEventListener('click', (e) => {
    const li = e.target.closest('li[data-cat]'); 
    if (!li) return;
    
    catList.querySelectorAll('li').forEach(n => n.classList.remove('active'));
    li.classList.add('active');
    state.cat = li.dataset.cat;
    applyFilters();
  });
  
  searchBtn.addEventListener('click', () => { 
    state.search = searchInput.value; 
    applyFilters(); 
  });
  
  searchInput.addEventListener('keydown', e => { 
    if (e.key === 'Enter') { 
      state.search = searchInput.value; 
      applyFilters(); 
    }
  });
  
  filterOpen.addEventListener('change', () => { 
    state.open = filterOpen.value; 
    applyFilters(); 
  });
  
  sortBySel.addEventListener('change', () => { 
    state.sort = sortBySel.value; 
    applyFilters(); 
  });

  // Map interactions
  rfMap.addEventListener('click', e => { 
    if (!e.target.closest('.poi-pin')) hideCard(); 
  });
  
  cardClose.addEventListener('click', hideCard);

  // Initial render
  console.log('Initializing map...'); // Debug
  console.log('Region coordinates:', REGION_COORDS); // Debug
  console.log('Places with coordinates:', PLACES_WITH_COORDS); // Debug
  applyFilters();
  
  // Select first place after a short delay
  setTimeout(() => {
    if (PLACES_WITH_COORDS.length > 0) {
      selectPlace(PLACES_WITH_COORDS[0].id);
    }
  }, 1000);
});

// ===== PANEL SHOW/HIDE FUNCTIONALITY ===== 
document.addEventListener('DOMContentLoaded', () => {
  const navPanel = document.getElementById('navPanel');
  const panelBack = document.getElementById('panelBack');
  const panelClose = document.getElementById('panelClose');
  const navPill = document.querySelector('.pill-left');
  
  if (!navPanel || !navPill) return;

  function togglePanel() {
    const isOpening = navPanel.classList.contains('hidden');
    
    if (isOpening) {
      // Показываем панель, скрываем кнопку
      navPanel.classList.remove('hidden');
      navPill.style.opacity = '0';
      navPill.style.visibility = 'hidden';
      navPill.classList.add('active');
    } else {
      // Скрываем панель, показываем кнопку
      navPanel.classList.add('hidden');
      navPill.style.opacity = '1';
      navPill.style.visibility = 'visible';
      navPill.classList.remove('active');
    }
    
    navPill.setAttribute('aria-label', isOpening ? 'Скрыть навигацию' : 'Показать навигацию');
  }

  // Показать панель при нажатии на кнопку "Навигация"
  navPill.addEventListener('click', (e) => {
    e.preventDefault();
    togglePanel();
  });

  // Скрыть панель при нажатии на кнопку назад
  panelBack.addEventListener('click', () => {
    hidePanel();
  });

  // Скрыть панель при нажатии на кнопку закрытия
  panelClose.addEventListener('click', () => {
    hidePanel();
  });

  // Функция для скрытия панели
  function hidePanel() {
    navPanel.classList.add('hidden');
    navPill.style.opacity = '1';
    navPill.style.visibility = 'visible';
    navPill.classList.remove('active');
  }

  // Скрыть панель при клике вне ее области
  document.addEventListener('click', (e) => {
    if (!navPanel.contains(e.target) && 
        !navPill.contains(e.target) && 
        !navPanel.classList.contains('hidden')) {
      hidePanel();
    }
  });

  // Предотвращаем закрытие при клике внутри панели
  navPanel.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Закрытие по клавише Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !navPanel.classList.contains('hidden')) {
      hidePanel();
    }
  });

  // Авто-скрытие на мобильных устройствах
  function checkMobileView() {
    if (window.innerWidth <= 768) {
      hidePanel();
    }
  }

  // Проверяем при загрузке и изменении размера
  checkMobileView();
  window.addEventListener('resize', checkMobileView);
});