// ===== NAVIGATION PAGE ONLY =====
document.addEventListener('DOMContentLoaded', () => {
  const rfMap = document.getElementById('rfMap');
  if (!rfMap) return; // run only on navigation page

  const pinsLayer = document.getElementById('map-pins');
  const placeList = document.getElementById('place-list');
  const placeCard = document.getElementById('place-card');
  const cardClose = placeCard.querySelector('.card-close');
  const catList = document.getElementById('category-list');

  const searchInput = document.getElementById('nav-search');
  const searchBtn = document.getElementById('nav-search-btn');
  const filterOpen = document.getElementById('filter-open');
  const sortBySel = document.getElementById('sort-by');

  // Функция для получения координат региона из SVG
  function getRegionCenter(regionCode) {
    const path = document.querySelector(`path[data-code="${regionCode}"]`);
    if (!path) {
      console.warn(`Регион с кодом ${regionCode} не найден на карте`);
      return { x: 50, y: 50 }; // Центр карты по умолчанию
    }
    
    const svg = rfMap.querySelector('svg');
    const svgRect = svg.getBoundingClientRect();
    const bbox = path.getBBox();
    
    return {
      x: ((bbox.x + bbox.width / 2) / svgRect.width) * 100,
      y: ((bbox.y + bbox.height / 2) / svgRect.height) * 100
    };
  }

  // Автоматически инициализируем координаты регионов
  function initializeRegionCoords() {
    const regions = {};
    const paths = document.querySelectorAll('path[data-code]');
    
    paths.forEach(path => {
      const code = path.getAttribute('data-code');
      regions[code] = getRegionCenter(code);
    });
    
    return regions;
  }

  // Функция для автоматического распределения точек внутри региона
  function getRegionCoords(regionCode, index = 0, totalInRegion = 1, regionCoords) {
    const base = regionCoords[regionCode] || { x: 50, y: 50 };
    
    // Если в регионе только одно место - ставим в центр
    if (totalInRegion === 1) return base;
    
    // Для нескольких мест создаем сетку вокруг центра
    const gridSize = Math.ceil(Math.sqrt(totalInRegion));
    const spacing = 2; // расстояние между точками в %
    
    const row = Math.floor(index / gridSize);
    const col = index % gridSize;
    
    const offsetX = (col - (gridSize - 1) / 2) * spacing;
    const offsetY = (row - (gridSize - 1) / 2) * spacing;
    
    return {
      x: Math.max(2, Math.min(98, base.x + offsetX)),
      y: Math.max(2, Math.min(98, base.y + offsetY))
    };
  }

  // Автоматически назначаем координаты местам
  function assignCoordinatesToPlaces(places, regionCoords) {
    // Группируем места по регионам
    const placesByRegion = {};
    places.forEach(place => {
      if (!placesByRegion[place.region]) {
        placesByRegion[place.region] = [];
      }
      placesByRegion[place.region].push(place);
    });
    
    // Назначаем координаты для каждого региона
    Object.keys(placesByRegion).forEach(regionCode => {
      const placesInRegion = placesByRegion[regionCode];
      placesInRegion.forEach((place, index) => {
        if (!place.coords) {
          place.coords = getRegionCoords(regionCode, index, placesInRegion.length, regionCoords);
        }
      });
    });
    
    return places;
  }

  const PLACES = [
    { 
      id: 'p-ryba', 
      title: 'Новое поколение', 
      cat: 'restaurant', 
      region: 'RU-MOW',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '0.5 км', 
      time: '21 октября 2025',
      desc: 'Программа краткосрочных ознакомительных поездок в Россию молодых представителей политических, общественных, научных и деловых кругов иностранных государств. Каждый год в рамках Программы Россотрудничество совместно с партнерскими организациями приглашает в Россию молодых иностранных делегатов из разных стран.',
      img: '/PICS_LOGOs/novoe-pokolenie.jpg',
      url: '#', 
      reserveUrl: '#'
      // coords будет назначено автоматически
    },
    { 
      id: 'p-rest2', 
      title: 'Здравствуй, Россия!', 
      cat: 'restaurant', 
      region: 'RU-SPE',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '1.2 км', 
      time: '21 октября 2025',
      desc: ' С 2014 года Россотрудничество реализует программу  для молодых соотечественников. Ежегодно порядка 700 подростков в возрасте от 14 до 19 лет из стран ближнего и дальнего зарубежья приезжают в Россию, чтобы познакомиться с её современной жизнью, образовательными и карьерными возможностями, прочувствовать многонациональную культуру своей исторической Родины, попрактиковаться в русском языке и найти новых друзей из разных стран.',
      img: '/PICS_LOGOs/hello_Rus.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'p-museum1', 
      title: 'Миссия добро', 
      cat: 'restaurant', 
      region: 'RU-MOW',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Проект способствует развитию международного волонтерства в России и гуманитарного взаимодействия с зарубежными странами.',
      img: '/PICS_LOGOs/missia_dobro.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'ross_4', 
      title: 'Время добрых дел', 
      cat: 'restaurant', 
      region: 'RU-MOW',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Социальный проект реализуется совместно с социально ориентированными некоммерческими организациями. С учетом региональной специфики партнеры Россотрудничества подбирают российских спикеров, экспертов мирового уровня, которые проводят на базе Русских домов круглые столы, тренинги и мастер-классы, делятся с коллегами лучшими практиками.',
      img: '/PICS_LOGOs/vremya_dobr_del.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'dv_per_1', 
      title: 'Международный фестиваль детства и юности «Фестиваль Движения Первых»', 
      cat: 'restaurant', 
      region: 'RU-MOW',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Международный ежегодный фестиваль, посвященный детям и юности, организованный Российским движением детей и молодёжи «Движение Первых».',
      img: '/PICS_LOGOs/dv_per_1.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_1', 
      title: 'Форумы России и других стран', 
      cat: 'restaurant', 
      region: 'RU-MOW',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Российско-Белорусский молодёжный форум проводится ежегодно с 2013 года по инициативе Ассоциации общественных объединений «Национальный Совет молодёжных и детских объединений России» и Общественного объединения «Белорусский республиканский союз молодёжи».',
      img: '/PICS_LOGOs/mez_mol_sot_1.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_2', 
      title: 'Международный молодёжный форум в рамках проекта «Культурная дипломатия в России»', 
      cat: 'restaurant', 
      region: 'RU-KR',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Краснодар собрал 50 активных российских и зарубежных молодежных представителей неправительственных организаций, а также иностранных студентов российских вузов. В рамках мероприятия ребята смогут посетить интерактивные мастер-классы, обсуждения, встретиться с экспертами в области культурной дипломатии. Кроме того, участники посетят город Майкоп, где  познакомятся с традициями, национальной кухней, достопримечательностями и историей Республики Адыгея.',
      img: '/PICS_LOGOs/vremya_dobr_del.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_3_moda', 
      title: 'Мода Фест', 
      cat: 'restaurant', 
      region: 'RU-KR',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: '«МодаФест» – флагманское событие модной индустрии на Юге России. Это комплексное отраслевое мероприятие, которое способствует развитию модной индустрии, популяризации и масштабированию локальных брендов, а также привлечению инвестиций.',
      img: '/PICS_LOGOs/mez_mol_sot_3_moda.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_3', 
      title: 'Молодежный день в рамках Кавказского инвестиционного форума', 
      cat: 'restaurant', 
      region: 'Северо-Кавказский федеральный округ',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Ключевое событие для молодежного сообщества, где молодые специалисты, студенты и школьники имеют возможность лично задать вопросы представителям бизнеса и государства, а также презентовать инициативы и стартапы.',
      img: '/PICS_LOGOs/mez_mol_sot_3.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_4', 
      title: 'Международный молодёжный форум «МедиаВесна СКФУ»', 
      cat: 'restaurant', 
      region: 'Северо-Кавказский федеральный округ',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Цель форума – объединить начинающих специалистов на международной молодёжной площадке для обмена знаниями и практическим опытом в сфере медиакоммуникаций и социального проектирования. Участники форума смогут представить свои научно-исследовательские работы и творческие проекты, получить обратную связь и найти партнеров для реализации идей.',
      img: '/PICS_LOGOs/mez_mol_sot_4.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_4_4', 
      title: 'Международный форум «Кавказ-Каспий-Ближний Восток»', 
      cat: 'restaurant', 
      region: 'Северо-Кавказский федеральный округ',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Мероприятие объединило более 100 представителей студенческой молодёжи из 15 стран мира, включая Тунис, Алжир, Турцию, Узбекистан, Армению, Египет, Азербайджан, а также иностранных студентов крупнейших вузов Юга России.',
      img: '/PICS_LOGOs/mez_mol_sot_4_4.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_5', 
      title: 'Международный образовательный форум «Алтай-Азия»', 
      cat: 'restaurant', 
      region: 'Алтай',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Алтайский государственный университет совместно с Российским университетом дружбы народов имени Патриса Лумумбы при поддержке Министерства науки и высшего образования Российской Федерации, Ассоциации Азиатских университетов, организуют VI Международный образовательный форум «Алтай-Азия 2024: Евразийское образовательное пространство – новые вызовы и лучшие практики».',
      img: '/PICS_LOGOs/mez_mol_sot_5.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_6', 
      title: 'Международный молодёжный форум «Байкал»', 
      cat: 'restaurant', 
      region: 'Иркутская область',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Цель форума – развитие компетенций успешного молодого человека, включая сферы его жизни и деятельности, прежде всего взаимодействие с природой и обществом, личностной и профессиональной самореализации молодых людей, формирование коммуникативной среды и условий поддержки молодежных инициатив.',
      img: '/PICS_LOGOs/mez_mol_sot_6.jpg',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_7', 
      title: 'Байкальский молодёжный форум', 
      cat: 'restaurant', 
      region: 'Иркутская область',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'Байкальский молодежный форум объединил 200 представителей молодежи из 7 регионов России и 5 стран мира. За время форума участники не только получили знания от федеральных и региональных экспертов, но выполняли задания в командах на всех площадках и разрабатывали собственные проекты.',
      img: '/PICS_LOGOs/mez_mol_sot_7.png',
      url: '#', 
      reserveUrl: '#'
    },
    { 
      id: 'mez_mol_sot_8', 
      title: 'Инвестиционный форум «Тыва: Агроинвест-2025»', 
      cat: 'restaurant', 
      region: 'Республика Тыва',
      city: '-', 
      address: 'ул. Молодежная, 18', 
      rating: 5, 
      distance: '2.1 км', 
      time: '21 октября 2025',
      desc: 'В ходе мероприятия, собравшего представителей российского и международного сельскохозяйственного бизнес-сообщества, было подписано 30 соглашений о сотрудничестве, значительная доля которых направлена на привлечение инвестиций в аграрный и животноводческий сектор республики.',
      img: '/PICS_LOGOs/mez_mol_sot_8.jpg',
      url: '#', 
      reserveUrl: '#'
    }


  ];

  // Инициализация координат регионов и назначение координат местам
  const REGION_COORDS = initializeRegionCoords();
  const PLACES_WITH_COORDS = assignCoordinatesToPlaces(PLACES, REGION_COORDS);

  const fmt = { rating: r => `${r.toFixed(1)}★` };
  let state = { cat: 'restaurant', search: '', open: 'all', sort: 'near', selectedId: null };

  // Render helpers
  function renderList(items) {
    placeList.innerHTML = '';
    items.forEach(p => {
      const el = document.createElement('div');
      el.className = 'place-item';
      el.dataset.id = p.id;
      el.innerHTML = `
        <img src="${p.img}" alt="${p.title}">
        <div>
          <div class="ptitle">${p.title}</div>
          <div class="pmeta">${p.distance} • ${p.time}</div>
        </div>
        <div class="pmeta">${fmt.rating(p.rating)}</div>`;
      el.addEventListener('click', () => selectPlace(p.id));
      placeList.appendChild(el);
    });
  }

  function renderPins(items) {
    console.log('Rendering pins:', items.length); // Debug
    pinsLayer.innerHTML = '';
    
    items.forEach(p => {
      const pin = document.createElement('button');
      pin.className = `poi-pin ${p.cat}`;
      pin.style.left = p.coords.x + '%';
      pin.style.top = p.coords.y + '%';
      pin.title = p.title;
      pin.dataset.id = p.id;
      
      pin.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        selectPlace(p.id); 
      });
      
      pinsLayer.appendChild(pin);
    });
  }

  function applyFilters() {
    const q = state.search.trim().toLowerCase();
    let items = PLACES_WITH_COORDS.filter(p =>
      (state.cat === 'all' || p.cat === state.cat) &&
      (q === '' || p.title.toLowerCase().includes(q) || p.address.toLowerCase().includes(q))
    );
    
    if (state.open === 'open') items = items.filter(p => !/закрыто/i.test(p.time));
    if (state.open === 'closed') items = items.filter(p => /закрыто/i.test(p.time));
    if (state.sort === 'rating') items.sort((a, b) => b.rating - a.rating);
    if (state.sort === 'az') items.sort((a, b) => a.title.localeCompare(b.title));

    renderList(items);
    renderPins(items);
    
    if (!items.some(p => p.id === state.selectedId)) hideCard();
  }

  function selectPlace(id) {
  state.selectedId = id;
  
  document.querySelectorAll('.place-item').forEach(n => 
    n.classList.toggle('active', n.dataset.id === id));
  document.querySelectorAll('.poi-pin').forEach(n => 
    n.classList.toggle('active', n.dataset.id === id));

  const p = PLACES_WITH_COORDS.find(x => x.id === id);
  if (!p) return;

  // Fill popup
  placeCard.querySelector('.card-img').src = p.img;
  placeCard.querySelector('.card-img').alt = p.title;
  placeCard.querySelector('.card-title').textContent = p.title;
  placeCard.querySelector('.card-distance').textContent = p.distance;
  placeCard.querySelector('.card-time').textContent = p.time;
  placeCard.querySelector('.rating-value').textContent = p.rating.toFixed(1);
  placeCard.querySelector('.addr-btn').textContent = p.address;
  placeCard.querySelector('.card-desc').textContent = p.desc;
  placeCard.querySelector('.more-btn').href = p.url || '#';
  placeCard.querySelector('.reserve-btn').href = p.reserveUrl || '#';

  positionCard(p.coords);
  placeCard.hidden = false;
}

  function positionCard(coords) {
    const wrap = document.getElementById('mapWrap');
    const mapBox = document.getElementById('rfMap');
    
    if (!wrap || !mapBox) return;
    
    const wrapRect = wrap.getBoundingClientRect();
    const mapRect = mapBox.getBoundingClientRect();

    let left = (coords.x / 100) * mapRect.width + (mapRect.left - wrapRect.left) + 16;
    let top = (coords.y / 100) * mapRect.height + (mapRect.top - wrapRect.top) - 16;

    const w = placeCard.offsetWidth || 400;
    const h = placeCard.offsetHeight || 230;

    const maxL = wrap.clientWidth - w - 24;
    const maxT = wrap.clientHeight - h - 24;
    
    if (left > maxL) left = (coords.x / 100) * mapRect.width + (mapRect.left - wrapRect.left) - w - 16;
    left = Math.max(24, Math.min(left, maxL));
    top = Math.max(24, Math.min(top, maxT));

    placeCard.style.left = left + 'px';
    placeCard.style.top = top + 'px';
  }

  function hideCard() {
    placeCard.hidden = true;
    state.selectedId = null;
    document.querySelectorAll('.poi-pin.active').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.place-item.active').forEach(n => n.classList.remove('active'));
  }

  // UI event listeners
  catList.addEventListener('click', (e) => {
    const li = e.target.closest('li[data-cat]'); 
    if (!li) return;
    
    catList.querySelectorAll('li').forEach(n => n.classList.remove('active'));
    li.classList.add('active');
    state.cat = li.dataset.cat;
    applyFilters();
  });
  
  searchBtn.addEventListener('click', () => { 
    state.search = searchInput.value; 
    applyFilters(); 
  });
  
  searchInput.addEventListener('keydown', e => { 
    if (e.key === 'Enter') { 
      state.search = searchInput.value; 
      applyFilters(); 
    }
  });
  
  filterOpen.addEventListener('change', () => { 
    state.open = filterOpen.value; 
    applyFilters(); 
  });
  
  sortBySel.addEventListener('change', () => { 
    state.sort = sortBySel.value; 
    applyFilters(); 
  });

  // Map interactions
  rfMap.addEventListener('click', e => { 
    if (!e.target.closest('.poi-pin')) hideCard(); 
  });
  
  cardClose.addEventListener('click', hideCard);

  // Initial render
  console.log('Initializing map...'); // Debug
  console.log('Region coordinates:', REGION_COORDS); // Debug
  console.log('Places with coordinates:', PLACES_WITH_COORDS); // Debug
  applyFilters();
  
  // Select first place after a short delay
  setTimeout(() => {
    if (PLACES_WITH_COORDS.length > 0) {
      selectPlace(PLACES_WITH_COORDS[0].id);
    }
  }, 1000);
});

// ===== PANEL SHOW/HIDE FUNCTIONALITY ===== 
document.addEventListener('DOMContentLoaded', () => {
  const navPanel = document.getElementById('navPanel');
  const panelBack = document.getElementById('panelBack');
  const panelClose = document.getElementById('panelClose');
  const navPill = document.querySelector('.pill-left');
  
  if (!navPanel || !navPill) return;

  function togglePanel() {
    const isOpening = navPanel.classList.contains('hidden');
    
    if (isOpening) {
      // Показываем панель, скрываем кнопку
      navPanel.classList.remove('hidden');
      navPill.style.opacity = '0';
      navPill.style.visibility = 'hidden';
      navPill.classList.add('active');
    } else {
      // Скрываем панель, показываем кнопку
      navPanel.classList.add('hidden');
      navPill.style.opacity = '1';
      navPill.style.visibility = 'visible';
      navPill.classList.remove('active');
    }
    
    navPill.setAttribute('aria-label', isOpening ? 'Скрыть навигацию' : 'Показать навигацию');
  }

  // Показать панель при нажатии на кнопку "Навигация"
  navPill.addEventListener('click', (e) => {
    e.preventDefault();
    togglePanel();
  });

  // Скрыть панель при нажатии на кнопку назад
  panelBack.addEventListener('click', () => {
    hidePanel();
  });

  // Скрыть панель при нажатии на кнопку закрытия
  panelClose.addEventListener('click', () => {
    hidePanel();
  });

  // Функция для скрытия панели
  function hidePanel() {
    navPanel.classList.add('hidden');
    navPill.style.opacity = '1';
    navPill.style.visibility = 'visible';
    navPill.classList.remove('active');
  }

  // Скрыть панель при клике вне ее области
  document.addEventListener('click', (e) => {
    if (!navPanel.contains(e.target) && 
        !navPill.contains(e.target) && 
        !navPanel.classList.contains('hidden')) {
      hidePanel();
    }
  });

  // Предотвращаем закрытие при клике внутри панели
  navPanel.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Закрытие по клавише Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !navPanel.classList.contains('hidden')) {
      hidePanel();
    }
  });

  // Авто-скрытие на мобильных устройствах
  function checkMobileView() {
    if (window.innerWidth <= 768) {
      hidePanel();
    }
  }

  // Проверяем при загрузке и изменении размера
  checkMobileView();
  window.addEventListener('resize', checkMobileView);
});